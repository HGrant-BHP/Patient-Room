<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
</head>
<body class="bg-[#f8f9fa]">
    <div class="admin-section">
        <div class="dashboard-header">
            <h1 class="text-white"><i class="fas fa-hospital-user"></i> Admin Dashboard</h1>
            
            <div class="valid-ids">
                <h2><i class="fas fa-key"></i> Valid IDs</h2>
                <div class="id-tags">
                    {{#each validIds}}
                        <a href="/user/{{this}}" class="id-tag" target="_{{this}}">{{this}}</a>
                    {{/each}}
                </div>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="dashboard-card">
                <div class="card-header">
                    <h2><i class="fas fa-users text-[#D4AF37]"></i> Connected Users</h2>
                </div>
                <div id="connectedUsers" class="card-content">
                    <!-- Users will be populated here -->
                </div>
            </div>

            <div class="dashboard-card">
                <div class="card-header">
                    <h2><i class="fas fa-bell text-[#D4AF37]"></i> Alert Log</h2>
                </div>
                <div id="alerts" class="card-content">
                    <!-- Alerts will be populated here -->
                </div>
            </div>
        </div>

        <div class="dashboard-card meal-dashboard">
            <div class="card-header">
                <h2><i class="fas fa-utensils text-[#D4AF37]"></i> Meal Selections</h2>
            </div>
            <div class="meal-times">
                <div class="meal-time-card">
                    <h3><i class="fas fa-sun text-[#D4AF37]"></i> Breakfast</h3>
                    <div id="breakfastSelections" class="selections-list"></div>
                </div>
                <div class="meal-time-card">
                    <h3><i class="fas fa-cloud-sun text-[#D4AF37]"></i> Lunch</h3>
                    <div id="lunchSelections" class="selections-list"></div>
                </div>
                <div class="meal-time-card">
                    <h3><i class="fas fa-moon text-[#D4AF37]"></i> Dinner</h3>
                    <div id="dinnerSelections" class="selections-list"></div>
                </div>
            </div>
        </div>

        <div class="dashboard-card mt-6">
            <div class="card-header">
                <h2><i class="fas fa-clipboard-list text-[#D4AF37]"></i> Survey Responses</h2>
            </div>
            <div id="surveyResponses" class="card-content">
                <!-- Survey responses will be populated here -->
            </div>
        </div>
    </div>

<style>
    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        background: #f8f9fa;
        margin: 0;
        padding: 0;
        color: #1a1a1a;
    }

    .admin-section {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem;
    }

    .dashboard-header {
        margin-bottom: 2rem;
    }

    .dashboard-header h1 {
        font-size: 2rem;
        font-weight: 600;
        color: #1a1a1a;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .valid-ids {
        background: white;
        padding: 1.5rem;
        border-radius: 1rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .valid-ids h2 {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .id-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .id-tag {
        background: #D4AF37;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-weight: 500;
    }

    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .dashboard-card {
        background: white;
        border-radius: 1rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        overflow: hidden;
    }

    .card-header {
        padding: 1.5rem;
        border-bottom: 1px solid #f1f1f1;
    }

    .card-header h2 {
        font-size: 1.25rem;
        font-weight: 600;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .card-content {
        padding: 1.5rem;
        max-height: 400px;
        overflow-y: auto;
    }

    .meal-dashboard {
        margin-top: 1.5rem;
    }

    .meal-times {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1.5rem;
        padding: 1.5rem;
    }

    .meal-time-card {
        background: #f8f9fa;
        padding: 1.5rem;
        border-radius: 0.75rem;
    }

    .meal-time-card h3 {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .selections-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .meal-selection {
        background: white;
        padding: 1rem;
        border-radius: 0.5rem;
        border-left: 3px solid #D4AF37;
    }

    .meal-selection .user-name {
        font-weight: 600;
        margin-bottom: 0.25rem;
    }

    .meal-selection .meal-name {
        color: #666;
        font-size: 0.9rem;
    }

    .user-item {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 0.75rem;
        margin-bottom: 0.75rem;
    }

    .user-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .name-section {
        flex: 1;
    }

    .name-display {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .user-name {
        font-weight: 600;
        font-size: 1.1rem;
    }

    .user-name.alert-active {
        color: #dc3545;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% {
            opacity: 1;
        }
        50% {
            opacity: 0.5;
        }
        100% {
            opacity: 1;
        }
    }

    .user-id {
        font-size: 0.9rem;
        color: #666;
        background: #f1f1f1;
        padding: 0.25rem 0.75rem;
        border-radius: 0.5rem;
    }

    .name-edit {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .name-edit input {
        flex: 1;
        padding: 0.5rem;
        border: 1px solid #e1e1e1;
        border-radius: 0.5rem;
        font-size: 1rem;
    }

    .save-btn, .edit-btn, .cancel-btn {
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        cursor: pointer;
        transition: background 0.2s;
        font-size: 0.9rem;
    }

    .save-btn {
        background: #D4AF37;
    }

    .edit-btn {
        background: #6c757d;
        padding: 0.25rem 0.5rem;
    }

    .cancel-btn {
        background: #dc3545;
    }

    .save-btn:hover, .edit-btn:hover, .cancel-btn:hover {
        opacity: 0.9;
    }

    .hidden {
        display: none;
    }

    .alert {
        background: #fff3cd;
        border-left: 3px solid #D4AF37;
        padding: 1rem;
        border-radius: 0.5rem;
        margin-bottom: 0.75rem;
    }

    .alert-popup {
        position: fixed;
        top: 2rem;
        right: 2rem;
        background: white;
        padding: 1.5rem;
        border-radius: 1rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        z-index: 1000;
        animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    /* Scrollbar styling */
    ::-webkit-scrollbar {
        width: 8px;
    }

    ::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
        background: #D4AF37;
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: #b08d2a;
    }

    .resolve-btn {
        background: #198754;
        color: white;
        border: none;
        padding: 0.25rem 0.75rem;
        border-radius: 0.5rem;
        cursor: pointer;
        transition: background 0.2s;
        font-size: 0.9rem;
        margin-left: 0.5rem;
    }

    .resolve-btn:hover {
        opacity: 0.9;
    }

    .survey-response {
        background: #f8f9fa;
        padding: 1.5rem;
        border-radius: 0.75rem;
        margin-bottom: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .survey-response:hover {
        background: #f1f1f1;
    }

    .survey-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .survey-user {
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .survey-timestamp {
        color: #666;
        font-size: 0.9rem;
    }

    .survey-answers {
        display: none;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #e5e5e5;
    }

    .survey-response.expanded .survey-answers {
        display: block;
    }

    .survey-answer {
        background: white;
        padding: 1rem;
        border-radius: 0.5rem;
        margin-bottom: 0.75rem;
    }

    .survey-answer:last-child {
        margin-bottom: 0;
    }

    .survey-question {
        font-weight: 500;
        margin-bottom: 0.5rem;
        color: #374151;
    }

    .survey-value {
        color: #666;
    }

    .survey-toggle {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .survey-toggle i {
        transition: transform 0.3s ease;
    }

    .survey-response.expanded .survey-toggle i {
        transform: rotate(180deg);
    }

    .request-survey-btn {
        padding: 0.25rem 0.75rem;
        background: #D4AF37;
        color: white;
        border: none;
        border-radius: 0.5rem;
        cursor: pointer;
        transition: background 0.2s;
        font-size: 0.9rem;
    }

    .request-survey-btn:hover {
        opacity: 0.9;
    }

    .accept-btn {
        background: #D4AF37;
        color: white;
        border: none;
        padding: 0.25rem 0.75rem;
        border-radius: 0.5rem;
        cursor: pointer;
        transition: background 0.2s;
        font-size: 0.9rem;
        margin-left: 0.5rem;
    }

    .accept-btn:hover {
        opacity: 0.9;
    }

    .patient-search {
        background: white;
        padding: 1.5rem;
        border-radius: 1rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        margin-bottom: 1.5rem;
    }

    .patient-search h2 {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .search-container {
        display: flex;
        gap: 0.5rem;
    }

    .search-input {
        flex: 1;
        padding: 0.75rem;
        border: 1px solid #e1e1e1;
        border-radius: 0.5rem;
        font-size: 1rem;
    }

    .search-btn {
        background: #D4AF37;
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        cursor: pointer;
        transition: background 0.2s;
    }

    .search-btn:hover {
        background: #B59030;
    }

    .patient-details {
        margin-top: 1rem;
        padding: 1rem;
        border: 1px solid #e1e1e1;
        border-radius: 0.5rem;
        background: #f8f9fa;
    }

    .patient-details.hidden {
        display: none;
    }

    .patient-info-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        margin-top: 1rem;
    }

    .patient-info-item {
        background: white;
        padding: 0.75rem;
        border-radius: 0.5rem;
        border: 1px solid #e1e1e1;
    }

    .patient-info-label {
        font-size: 0.875rem;
        color: #666;
        margin-bottom: 0.25rem;
    }

    .patient-info-value {
        font-weight: 500;
    }

    .error-message {
        color: #dc3545;
        padding: 0.75rem;
        background: #f8d7da;
        border-radius: 0.5rem;
        margin-top: 1rem;
    }

    .user-item {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 0.75rem;
        margin-bottom: 0.75rem;
    }

    .user-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .name-section {
        flex: 1;
    }

    .name-display {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .user-name {
        font-weight: 600;
        font-size: 1.1rem;
    }

    .user-name.alert-active {
        color: #dc3545;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% {
            opacity: 1;
        }
        50% {
            opacity: 0.5;
        }
        100% {
            opacity: 1;
        }
    }

    .user-id {
        font-size: 0.9rem;
        color: #666;
        background: #f1f1f1;
        padding: 0.25rem 0.75rem;
        border-radius: 0.5rem;
    }
</style>

<script>
    const socket = io();
    const connectedUsers = document.getElementById('connectedUsers');
    const alertsDiv = document.getElementById('alerts');
    let usersData = new Map();
    let persistentUserData = new Map(); // Store data for all approved users

    // Initialize persistent data for all valid IDs
    function initializePersistentData() {
        const validIdElements = document.querySelectorAll('.id-tag');
        validIdElements.forEach(element => {
            const userId = element.textContent;
            if (!persistentUserData.has(userId)) {
                persistentUserData.set(userId, {
                    userId,
                    name: 'Guest',
                    connected: false,
                    mealSelections: {
                        breakfast: null,
                        lunch: null,
                        dinner: null
                    }
                });
            }
        });
    }

    // Call initialization on page load
    initializePersistentData();

    // Socket connection status
    socket.on('connect', () => {
        console.log('Connected to server');
    });

    socket.on('disconnect', () => {
        console.log('Disconnected from server');
        // Mark all users as disconnected but keep their data
        for (let [userId, userData] of persistentUserData) {
            userData.connected = false;
        }
        updateUsersList();
    });

    // Handle users list update
    socket.on('users_list', (users) => {
        console.log('Received users:', users);
        users.forEach(user => {
            // Update connection status and sync with persistent data
            if (persistentUserData.has(user.userId)) {
                const persistentData = persistentUserData.get(user.userId);
                persistentData.connected = true;
                // If the user had a name before, restore it
                if (persistentData.name !== 'Guest') {
                    socket.emit('set_username', { socketId: user.id, username: persistentData.name });
                }
                // Update socket ID
                persistentData.socketId = user.id;
            }
            usersData.set(user.userId, user);
        });
        updateUsersList();
        updateMealSelectionsDisplay();
    });

    function updateUsersList() {
        // Create a map of all valid IDs with their current data
        const allUsers = new Map();
        persistentUserData.forEach((data, userId) => {
            allUsers.set(userId, {
                ...data,
                connected: false // Default to disconnected
            });
        });

        // Update connected users
        usersData.forEach((user, socketId) => {
            if (allUsers.has(user.userId)) {
                allUsers.get(user.userId).connected = true;
                allUsers.get(user.userId).name = user.name;
            }
        });

        const usersHtml = Array.from(allUsers.values()).map(user => `
            <div class="user-item" id="user-${user.userId}">
                <div class="user-info">
                    <div class="name-section">
                        <div class="name-display" id="name-display-${user.userId}">
                            <span class="user-name ${activeAlerts.has(user.userId) ? 'alert-active' : ''}" id="username-${user.userId}">
                                ${user.name}
                            </span>
                            <span class="user-id">ID: ${user.userId}</span>
                            <button class="edit-btn" onclick="toggleEdit('${user.userId}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="request-survey-btn" id="survey-btn-${user.userId}" onclick="requestSurvey('${user.userId}')">
                                <i class="fas fa-clipboard-list"></i> Request Survey
                            </button>
                        </div>
                        <div class="name-edit hidden" id="name-edit-${user.userId}">
                            <input type="text" class="name-input" placeholder="Enter Patient ID" value="">
                            <button class="save-btn" onclick="handleSave('${user.userId}', this.previousElementSibling.value)">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="cancel-btn" onclick="handleCancel('${user.userId}')">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
        
        connectedUsers.innerHTML = usersHtml || '<p class="no-users">No valid IDs configured</p>';
    }

    function saveUsername(socketId, username) {
        if (username.trim()) {
            socket.emit('set_username', { socketId, username: username.trim() });
            // Update both current and persistent data
            for (let [userId, userData] of persistentUserData) {
                if (userData.socketId === socketId) {
                    userData.name = username.trim();
                    break;
                }
            }
            const displayDiv = document.getElementById(`name-display-${socketId}`);
            const editDiv = document.getElementById(`name-edit-${socketId}`);
            displayDiv.querySelector('.user-name').textContent = username.trim();
            displayDiv.classList.remove('hidden');
            editDiv.classList.add('hidden');
        }
    }

    // Update meal selections display
    function updateMealSelectionsDisplay() {
        document.getElementById('breakfastSelections').innerHTML = '';
        document.getElementById('lunchSelections').innerHTML = '';
        document.getElementById('dinnerSelections').innerHTML = '';
        
        for (let [userId, userData] of persistentUserData) {
            if (userData.mealSelections) {
                ['breakfast', 'lunch', 'dinner'].forEach(type => {
                    const selection = userData.mealSelections[type];
                    if (selection) {
                        const container = document.getElementById(`${type}Selections`);
                        const selectionElement = document.createElement('div');
                        selectionElement.className = 'meal-selection';
                        selectionElement.innerHTML = `
                            <div class="user-name">${userData.name} (${userId})</div>
                            <div class="meal-name">${selection.name}</div>
                        `;
                        container.appendChild(selectionElement);
                    }
                });
            }
        }
    }

    // Handle meal selections update
    socket.on('meal_selections', (selections) => {
        console.log('Received meal selections update');
        selections.forEach(selection => {
            if (persistentUserData.has(selection.userId)) {
                const userData = persistentUserData.get(selection.userId);
                userData.mealSelections = {
                    breakfast: selection.breakfast || null,
                    lunch: selection.lunch || null,
                    dinner: selection.dinner || null
                };
            }
        });
        updateMealSelectionsDisplay();
    });

    // Store users with active alerts
    let activeAlerts = new Set();

    // Handle user alerts
    socket.on('user_alert', ({ socketId, userId, username }) => {
        console.log('Alert received:', { socketId, userId, username });
        
        // Add user to active alerts
        activeAlerts.add(socketId);
        
        // Update user display to show alert state
        const usernameElement = document.getElementById(`username-${socketId}`);
        const nameDisplayElement = document.getElementById(`name-display-${socketId}`);
        if (usernameElement) {
            usernameElement.classList.add('alert-active');
            // Add accept button if it doesn't exist
            if (!nameDisplayElement.querySelector('.accept-btn')) {
                const acceptBtn = document.createElement('button');
                acceptBtn.className = 'accept-btn';
                acceptBtn.onclick = () => acceptAlert(socketId, userId, username);
                acceptBtn.textContent = 'Accept';
                nameDisplayElement.appendChild(acceptBtn);
            }
        }
        
        // Create popup
        const popup = document.createElement('div');
        popup.className = 'alert-popup';
        popup.innerHTML = `
            <div class="popup-content">
                <h3>Alert Received!</h3>
                <p><strong>${username}</strong></p>
                <p>ID: ${userId}</p>
                <p>Time: ${new Date().toLocaleTimeString()}</p>
                <button onclick="this.parentElement.parentElement.remove()">Close</button>
            </div>
        `;
        document.body.appendChild(popup);

        // Add to alert log
        const alertElement = document.createElement('div');
        alertElement.className = 'alert';
        alertElement.innerHTML = `
            <p><strong>${username}</strong> (ID: ${userId}) sent an alert at ${new Date().toLocaleTimeString()}</p>
        `;
        alertsDiv.insertBefore(alertElement, alertsDiv.firstChild);

        // Auto-remove popup after 10 seconds
        setTimeout(() => popup.remove(), 10000);
    });

    function acceptAlert(socketId, userId, username) {
        // Update user display
        const nameDisplayElement = document.getElementById(`name-display-${socketId}`);
        if (nameDisplayElement) {
            // Remove accept button
            const acceptBtn = nameDisplayElement.querySelector('.accept-btn');
            if (acceptBtn) {
                acceptBtn.remove();
            }
            
            // Add resolve button if it doesn't exist
            if (!nameDisplayElement.querySelector('.resolve-btn')) {
                const resolveBtn = document.createElement('button');
                resolveBtn.className = 'resolve-btn';
                resolveBtn.onclick = () => resolveAlert(socketId, userId, username);
                resolveBtn.textContent = 'Resolved';
                nameDisplayElement.appendChild(resolveBtn);
            }
        }
        
        // Add to alert log
        const alertElement = document.createElement('div');
        alertElement.className = 'alert';
        alertElement.innerHTML = `
            <p><strong>${username}</strong> (ID: ${userId}) alert was accepted at ${new Date().toLocaleTimeString()}</p>
        `;
        alertsDiv.insertBefore(alertElement, alertsDiv.firstChild);

        // Emit alert accepted event
        socket.emit('alert_accepted', { socketId, userId, username });
    }

    function resolveAlert(socketId, userId, username) {
        // Remove from active alerts
        activeAlerts.delete(socketId);
        
        // Update user display
        const usernameElement = document.getElementById(`username-${socketId}`);
        const nameDisplayElement = document.getElementById(`name-display-${socketId}`);
        if (usernameElement) {
            usernameElement.classList.remove('alert-active');
            // Remove resolve button
            const resolveBtn = nameDisplayElement.querySelector('.resolve-btn');
            if (resolveBtn) {
                resolveBtn.remove();
            }
        }
        
        // Add resolution to alert log
        const alertElement = document.createElement('div');
        alertElement.className = 'alert';
        alertElement.innerHTML = `
            <p><strong>${username}</strong> (ID: ${userId}) alert was resolved at ${new Date().toLocaleTimeString()}</p>
        `;
        alertsDiv.insertBefore(alertElement, alertsDiv.firstChild);
    }

    // Handle user disconnection
    socket.on('user_disconnected', (socketId) => {
        console.log('User disconnected:', socketId);
        const userElement = document.getElementById(`user-${socketId}`);
        if (userElement) {
            userElement.remove();
        }
    });

    async function fetchPatientDetails(patientId, socketId, input) {
        try {
            const response = await fetch(`http://localhost/Hospital-Management-System/api/patients.php?id=${patientId}`, {
                headers: {
                    'Authorization': 'Bearer 2c45d45b9f1cd49e1614b6e7b78c4c55d7aa1b2ff7fb6670d7ee3845e0eb6668'
                }
            });
            const data = await response.json();
            
            if (data.error) {
                alert('Patient not found');
                return false;
            }

            // Format the patient's full name
            const fullName = `${data.first_name} ${data.middle_name} ${data.last_name}`.trim();
            
            // Update the input value with the patient's name
            input.value = fullName;
            
            // Auto-save the username
            saveUsername(socketId, fullName);
            return true;
        } catch (error) {
            console.error('Error fetching patient data:', error);
            alert('Error fetching patient data. Please try again.');
            return false;
        }
    }

    function toggleEdit(socketId) {
        const displayDiv = document.getElementById(`name-display-${socketId}`);
        const editDiv = document.getElementById(`name-edit-${socketId}`);
        const input = editDiv.querySelector('input');
        
        displayDiv.classList.toggle('hidden');
        editDiv.classList.toggle('hidden');
        
        if (!editDiv.classList.contains('hidden')) {
            // Clear the input and store the current name in a data attribute
            const currentName = displayDiv.querySelector('.user-name').textContent;
            input.dataset.previousName = currentName;
            input.value = '';
            input.focus();
            
            // Add event listener for Enter key
            input.onkeypress = async function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    await handleSave(socketId, this.value);
                }
            };
        }
    }

    async function handleSave(socketId, patientId) {
        const editDiv = document.getElementById(`name-edit-${socketId}`);
        const displayDiv = document.getElementById(`name-display-${socketId}`);
        const input = editDiv.querySelector('input');
        
        if (!patientId.trim()) {
            alert('Please enter a patient ID');
            return;
        }

        // Hide input box immediately
        displayDiv.classList.remove('hidden');
        editDiv.classList.add('hidden');

        const success = await fetchPatientDetails(patientId, socketId, input);
        if (!success) {
            // If failed, show input box again
            displayDiv.classList.add('hidden');
            editDiv.classList.remove('hidden');
            input.focus();
        } else {
            input.value = '';  // Clear the input after successful save
        }
    }

    function handleCancel(socketId) {
        const displayDiv = document.getElementById(`name-display-${socketId}`);
        const editDiv = document.getElementById(`name-edit-${socketId}`);
        const input = editDiv.querySelector('input');
        
        // Restore the previous name
        const previousName = input.dataset.previousName;
        displayDiv.querySelector('.user-name').textContent = previousName;
        
        // Clear the input
        input.value = '';
        
        // Hide/show the appropriate divs
        displayDiv.classList.remove('hidden');
        editDiv.classList.add('hidden');
    }

    // Store survey responses
    let surveyResponses = new Map();

    // Handle survey responses update
    socket.on('survey_responses', (responses) => {
        console.log('Received survey responses:', responses);
        responses.forEach(response => {
            surveyResponses.set(response.userId, response.responses);
        });
        updateSurveyResponsesDisplay();
    });

    // Store survey questions
    let surveyQuestions = null;

    // Fetch survey questions when page loads
    async function loadSurveyQuestions() {
        try {
            const response = await fetch('/data/survey_questions.json');
            const data = await response.json();
            surveyQuestions = data.questions;
        } catch (error) {
            console.error('Error loading survey questions:', error);
        }
    }

    // Load questions when page loads
    loadSurveyQuestions();

    function updateSurveyResponsesDisplay() {
        const container = document.getElementById('surveyResponses');
        if (surveyResponses.size === 0) {
            container.innerHTML = '<p class="no-responses">No survey responses yet</p>';
            return;
        }

        const responsesHtml = Array.from(surveyResponses.entries()).map(([userId, answers]) => {
            const userData = usersData.get(userId) || { name: 'Unknown User', userId };
            return `
                <div class="survey-response" onclick="toggleSurvey(this)">
                    <div class="survey-header">
                        <div class="survey-user">
                            <i class="fas fa-user text-[#D4AF37]"></i>
                            ${userData.name} (${userId})
                        </div>
                        <div class="survey-toggle">
                            <span class="survey-timestamp">${new Date().toLocaleDateString()}</span>
                            <i class="fas fa-chevron-down text-[#D4AF37]"></i>
                        </div>
                    </div>
                    <div class="survey-answers">
                        ${answers.map(answer => {
                            const question = surveyQuestions?.find(q => q.id === parseInt(answer.questionId));
                            return `
                                <div class="survey-answer">
                                    <div class="survey-question">${question ? question.question : `Question ${answer.questionId}`}</div>
                                    <div class="survey-value">${answer.value}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }).join('');

        container.innerHTML = responsesHtml;
    }

    function toggleSurvey(element) {
        element.classList.toggle('expanded');
    }

    function requestSurvey(userId) {
        // Hide the button immediately
        const surveyBtn = document.getElementById(`survey-btn-${userId}`);
        if (surveyBtn) {
            surveyBtn.style.display = 'none';
        }
        // Emit the socket event
        socket.emit('request_survey', { userId });
    }

    async function searchPatient() {
        const patientId = document.getElementById('patientId').value.trim();
        if (!patientId) {
            alert('Please enter a patient ID');
            return;
        }

        try {
            const response = await fetch(`http://localhost/Hospital-Management-System/api/patients.php?id=${patientId}`, {
                headers: {
                    'Authorization': 'Bearer 2c45d45b9f1cd49e1614b6e7b78c4c55d7aa1b2ff7fb6670d7ee3845e0eb6668'
                }
            });
            const data = await response.json();
            
            if (data.error) {
                alert('Patient not found');
                return;
            }

            // Format the patient's full name
            const fullName = `${data.first_name} ${data.middle_name} ${data.last_name}`.trim();
            
            // Get the first connected user (assuming we're setting it for the first/only user)
            const firstUser = Array.from(usersData.values())[0];
            if (firstUser) {
                // Update the username through the socket
                socket.emit('set_username', { socketId: firstUser.id, username: fullName });
                
                // Clear the search input
                document.getElementById('patientId').value = '';
            } else {
                alert('No connected user found');
            }
        } catch (error) {
            console.error('Error fetching patient data:', error);
            alert('Error fetching patient data. Please try again.');
        }
    }

    // Add event listener for Enter key
    document.getElementById('patientId').addEventListener('keypress', function(event) {
        if (event.key === 'Enter') {
            searchPatient();
        }
    });

    // Handle survey request status updates
    socket.on('survey_request_status', ({ userId, status }) => {
        const surveyBtn = document.getElementById(`survey-btn-${userId}`);
        if (surveyBtn) {
            if (status === 'active') {
                surveyBtn.style.display = 'none';
            } else {
                surveyBtn.style.display = 'inline-block';
            }
        }
    });

    // Handle bulk survey request status updates (on initial load)
    socket.on('survey_request_status_bulk', (requests) => {
        requests.forEach(({ userId, status }) => {
            const surveyBtn = document.getElementById(`survey-btn-${userId}`);
            if (surveyBtn && status === 'active') {
                surveyBtn.style.display = 'none';
            }
        });
    });
</script>
</body>
</html> 